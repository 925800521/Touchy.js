/*
	Touchy.js
	Socket-style finger management for touch events

	Jairaj Sethi
	http://creativecommons.org/licenses/by/3.0/
*/
(function(i){function j(a,b,c){a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent&&(a=a.attachEvent("on"+b,c),o[a]={name:b,callback:c})}function k(a,b,c){if(a.removeEventListener)a.removeEventListener(b,c,!1);else if(a.detachEvent)for(var d in o)o[d].name===b&&o[d].callback===c&&(a.detachEvent(d),delete o[d])}function u(a,b){function c(a){var b=Array.prototype.slice.call(arguments,1);if(e[a])return e[a].apply(this,b)}var d=a.prototype,e=b.prototype,g,f;for(f in e)d[f]=e[f];d._super?(g=d._super,
d._super=function(){g.call(this,arguments);c.call(this,arguments)}):d._super=c}function m(){this.onEvents={};this.onceEvents={}}function q(a){this._super("constructor");this.id=a;this.points=[]}function r(a){this._super("constructor");this.fingers=!a?[]:v(a,function(a){return new q(a)})}function n(a,b){return v(a,function(a){return{id:a.identifier,x:a.pageX,y:a.pageY,time:b}})}function s(a,b){return[{id:b,x:a.pageX,y:a.pageY,time:a.timeStamp}]}function f(a,b,c){"undefined"==typeof c&&(c=b,b=!1);"function"==
typeof c&&(c={any:c});for(var d in t)if(d in c){var e=t[d](a,c[d]);"function"==typeof e&&(e={any:e});for(var g in e)c[g]=g in c?function(a,b){return function(){a.call(this,arguments);b.call(this,arguments)}}(c[g],e[g]):e[g]}this.running=!1;this.elem=a;this.handleMouse=!!b;this.settings=c||{};this.mainHand=new r;this.mouseID=this.multiHand=null;this.start()}function p(a,b,c){return new f(a,b,c)}var i=i||{},h=function(){return Array.prototype.forEach?function(a,b,c){Array.prototype.forEach.call(a,b,
c)}:function(a,b,c){for(var d=0,e=a.length;d<e;d++)d in a&&b.call(c,a[d],d,a)}}(),l=function(){return Array.prototype.indexOf?function(a,b,c){return Array.prototype.indexOf.call(a,b,c)}:function(a,b,c){for(var c=c||0,d=a.length;c<d;c++)if(c in a&&a[c]===b)return c;return-1}}(),v=function(){return Array.prototype.map?function(a,b,c){return Array.prototype.map.call(a,b,c)}:function(a,b,c){for(var d=a.length,e=Array(d),g=0;g<d;g++)g in a&&(e[g]=b.call(c,a[g],g,a));return e}}(),x=function(){return Array.prototype.filter?
function(a,b,c){return Array.prototype.filter.call(a,b,c)}:function(a,b,c){for(var d=[],e,g=0,f=a.length;g<f;g++)e=a[g],g in a&&b.call(c,e,g,a)&&d.push(e);return d}}(),o={};m.prototype.on=function(a,b){if(b){if(a in this.onEvents){var c=l(this.onEvents[a],b);if(-1!=c)return}else this.onEvents[a]=[];a in this.onceEvents&&(c=l(this.onceEvents[a],b),-1!=c&&this.onceEvents.splice(c,1));this.onEvents[a].push(b)}};m.prototype.once=function(a,b){if(b){if(a in this.onceEvents){var c=l(this.onceEvents[a],
b);if(-1!=c)return}else this.onceEvents[a]=[];a in this.onEvents&&(c=l(this.onEvents[a],b),-1!=c&&this.onEvents.splice(c,1));this.onceEvents[a].push(b)}};m.prototype.off=function(a,b){if(b){if(a in this.onEvents){var c=l(this.onEvents[a],b);if(-1!=c){this.onEvents.splice(c,1);return}}a in this.onceEvents&&(c=l(this.onceEvents[a],b),-1!=c&&this.onceEvents.splice(c,1))}};m.prototype.trigger=function(a){for(var b=Array.prototype.slice.call(arguments,1),c=(this.onEvents[a]||[]).concat(this.onceEvents[a]||
[]),d;d=c.shift();)d.apply(this,b)};u(q,m);u(r,m);r.prototype.get=function(a){var b;h(this.fingers,function(c){c.id==a&&(b=c)});return b};f.prototype.start=function(){this.running||(this.running=!0,j(this.elem,"touchstart",this.touchstart()),j(this.elem,"touchmove",this.touchmove()),j(this.elem,"touchend",this.touchend()),this.handleMouse&&(j(this.elem,"mousedown",this.mousedown()),j(this.elem,"mouseup",this.mouseup()),j(this.elem,"mousemove",this.mousemove())))};f.prototype.stop=function(){this.running&&
(this.running=!1,k(this.elem,"touchstart",this.touchstart()),k(this.elem,"touchmove",this.touchmove()),k(this.elem,"touchend",this.touchend()),k(this.elem,"mousedown",this.mousedown()),k(this.elem,"mouseup",this.mouseup()),k(this.elem,"mousemove",this.mousemove()))};f.prototype.touchstart=function(){if(!this._touchstart){var a=this;this._touchstart=function(b){var c=n(b.touches,b.timeStamp),b=n(b.changedTouches,b.timeStamp);a.mainHandStart(b);a.multiHandStart(b,c)}}return this._touchstart};f.prototype.touchmove=
function(){if(!this._touchmove){var a=this;this._touchmove=function(b){var c=n(b.touches,b.timeStamp),b=n(b.changedTouches,b.timeStamp);a.mainHandMove(b);a.multiHandMove(b,c)}}return this._touchmove};f.prototype.touchend=function(){if(!this._touchend){var a=this;this._touchend=function(b){var c=n(b.touches,b.timeStamp),b=n(b.changedTouches,b.timeStamp);a.mainHandEnd(b);a.multiHandEnd(b,c)}}return this._touchend};f.prototype.mousedown=function(){if(!this._mousedown){var a=this;this._mousedown=function(b){var c;
a.mouseID&&(c=s(b,a.mouseID),a.mainHandEnd(c),a.multiHandEnd(c,c),a.mouseID=null);a.mouseID=Math.random()+"";c=s(b,a.mouseID);a.mainHandStart(c);a.multiHandStart(c,c)}}return this._mousedown};f.prototype.mouseup=function(){if(!this._mouseup){var a=this;this._mouseup=function(b){a.mouseID&&(b=s(b,a.mouseID),a.mainHandEnd(b),a.multiHandEnd(b,b),a.mouseID=null)}}return this._mouseup};f.prototype.mousemove=function(){if(!this._mousemove){var a=this;this._mousemove=function(b){a.mouseID&&(b=s(b,a.mouseID),
a.mainHandMove(b),a.multiHandMove(b,b))}}return this._mousemove};f.prototype.mainHandStart=function(a){var b=this,c=[];h(a,function(a){var e=new q(a.id);e.points.push(a);c.push([e,a]);b.mainHand.fingers.push(e)});h(c,function(a){b.settings.any&&b.settings.any.call(b,b.mainHand,a[0]);a[0].trigger("start",a[1])});b.mainHand.trigger("start",a)};f.prototype.mainHandMove=function(a){var b=this,c=[];h(a,function(a){var e=b.mainHand.get(a.id);e.points.push(a);c.push([e,a])});h(c,function(a){a[0].trigger("move",
a[1])});b.mainHand.trigger("move",a)};f.prototype.mainHandEnd=function(a){var b=this,c=[];h(a,function(a){var e=b.mainHand.get(a.id);e.points.push(a);c.push([e,a]);a=l(b.mainHand.fingers,e);b.mainHand.fingers.splice(a,1)});h(c,function(a){a[0].trigger("end",a[1])});b.mainHand.trigger("end",a)};f.prototype.multiHandStart=function(a,b){this.multiHandDestroy();this.multiHandRestart(b)};f.prototype.multiHandMove=function(a){var b=this,c=[];h(a,function(a){var e=b.multiHand.get(a.id);e.points.push(a);
c.push([e,a])});h(c,function(a){a[0].trigger("move",a[1])});b.multiHand.trigger("move",a)};f.prototype.multiHandEnd=function(a,b){this.multiHandDestroy();this.multiHandRestart(x(b,function(b){var d=!0;h(a,function(a){a.id==b.id&&(d=!1)});return d}))};f.prototype.multiHandRestart=function(a){var b=this;if(0!=a.length){b.multiHand=new r;var c=[];h(a,function(a){var d=new q(a.id);d.points.push(a);c.push([d,a]);b.multiHand.fingers.push(d)});var d=b.settings[{1:"one",2:"two",3:"three",4:"four",5:"five"}[b.multiHand.fingers.length]];
d&&d.apply(b,[b.multiHand].concat(b.multiHand.fingers));h(c,function(a){a[0].trigger("start",a[1])});b.multiHand.trigger("start",a)}};f.prototype.multiHandDestroy=function(){if(this.multiHand){var a=[];h(this.multiHand.fingers,function(b){var c=b.points[b.points.length-1];b.points.push(c);a.push(c);b.trigger("end",c)});this.multiHand.trigger("end",a);this.multiHand=null}};var t={};p.plugin=function(a,b){if(a in t)throw"Touchy: "+a+" plugin already defined";t[a]=b};var w=function(a){a.preventDefault()};
p.stopWindowBounce=function(){j(i,"touchmove",w)};p.startWindowBounce=function(){k(i,"touchmove",w)};i.Touchy=p;i.jQuery&&i.jQuery.fn&&(i.jQuery.fn.touchy=function(){var a=Array.prototype.slice.call(arguments);this.each(function(){var b=a.slice();b.unshift(this);p.apply(i,b)})})})(window);
